<?php
require_once("../config.inc.php");
session_start();
if (!isset($_SESSION['acct_manager']))
  $_SESSION['acct_manager']= new RODSAcctManager();


/*
$files=array();
$dirs=array();
if (isset($_REQUEST['files']))
  $files=$_REQUEST['files'];
if (isset($_REQUEST['dirs']))
  $dirs=$_REQUEST['dirs'];
if (isset($_REQUEST['rescs']))
  $rescs=$_REQUEST['rescs'];

if ( (empty($files))&&(empty($dirs)) )
{
  exitWithJsonError('No files or collections specified', RBERR_EXPECTED_INPUT_PARAM_MISSING);
}  

if ( empty($rescs) )
{
  exitWithJsonError('No resources specified', RBERR_EXPECTED_INPUT_PARAM_MISSING);
}  
*/

$items=array();
if (isset($_REQUEST['items']))
  $items=$_REQUEST['items'];

if ( empty($items) )
{
  exitWithJsonError('No items specified', RBERR_EXPECTED_INPUT_PARAM_MISSING);
}  
  
$force_delete=false;
if (isset($_REQUEST['force']))
  $force_delete=$_REQUEST['force'];
  
$additional_options=array();
if (isset($_REQUEST['rmtrash']))
{
  $rmtrash=true;
  array_push($additional_options,array('irodsRmTrash',''));
}
  
try {

  // make an iRODS account object for connection <- this uses the admin proxyuser
  $proxy_account = new RODSAccount(RODS_SVR_HOST, RODS_SVR_PORT, RODS_SVR_ADMIN_USER, NULL, RODS_SVR_ZONE);

  // get Shibboleth environment variables    
  $targetedId  = $_SERVER['persistent-id'];
  $affiliation = $_SERVER['affiliation'];
  $user_entitlement = $_SERVER['entitlement'];
  $attributes = "###".$targetedId."###".$affiliation."###".$user_entitlement."###";
  
  // save obfuscated attributes into user_info for each file/dir to be deleted
  $proxy_conn = RODSConnManager::getConn($proxy_account);

  $num_files=0;
  $num_dirs=0;
  
  for($i = 0, $size = sizeof($items); $i < $size; ++$i)
  {
    if (strlen($items[$i]['ruri'])>0)
    {
      if ($items[$i]['type'] == 0) // a directory
      {
        $mydir=ruri2ProdsDir($items[$i]['ruri']);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $mydir->account->user, "info", encode_attributes(ENCRYPT_KEY, $attributes));
        $mydir->rmdir(true, $force_delete, $additional_options);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $mydir->account->user, "info", "");      
        $num_dirs++;
      } else {
        $myfile=ruri2ProdsFile($items[$i]['ruri']);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $myfile->account->user, "info", encode_attributes(ENCRYPT_KEY, $attributes));                          
        
        // TODO: only delete the selected replica? get $rescname from the request
        $myfile->unlink($items[$i]['rescname'], $force_delete);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $myfile->account->user, "info", "");      
        $num_files++; 
      }
    }      
  }
  /*
  foreach ($items as $item)
  { 
    exitWithJsonError("item: '$size'" , RBERR_MULFORMATED_URI);     
    if (strlen($item['ruri'])>0)
    {
      if ($item['type'] == 0) // a directory
      {
        $mydir=ruri2ProdsDir($item['ruri']);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $mydir->account->user, "info", encode_attributes(ENCRYPT_KEY, $attributes));
        $mydir->rmdir(true, $force_delete, $additional_options);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $mydir->account->user, "info", "");      
        $num_dirs++;
      } else {
        $myfile=ruri2ProdsFile($item['ruri']);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $myfile->account->user, "info", encode_attributes(ENCRYPT_KEY, $attributes));                          
        
        // TODO: only delete the selected replica? get $rescname from the request
        $myfile->unlink($item['rescname'], $force_delete);
        $proxy_conn->iadmin("moduser", RODS_SVR_ADMIN_PASSWORD, $myfile->account->user, "info", "");      
        $num_files++; 
      }
    }
  }  
  */
  RODSConnManager::releaseConn($proxy_conn);
  $proxy_conn->disconnect();
  
  $response=array('success'=> true,'log'=>"$num_files files and $num_dirs collections deleted!");
  echo json_encode($response);
  
} catch (Exception $e) {
  exitWithException($e);  
}

  
?>
